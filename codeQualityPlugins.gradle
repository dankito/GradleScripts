
// TODO: does not work, doesn't get applied
buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.sonarsource.scanner.gradle:sonarqube-gradle-plugin:2.8"
    }
}

apply plugin: "jacoco"
//apply plugin: "org.sonarqube"


def integrationTestFolder = file("${buildscript.sourceFile.parent}/src/integrationTest")
def doesHaveIntegrationTests = integrationTestFolder.exists()



/*      JaCoCo          */

jacocoTestReport {
    if (doesHaveIntegrationTests) { // only adjust if integrationTest folder is created
        executionData(integrationTest) // add results from integrationTest task
    }

    reports {
        xml.enabled true
        csv.enabled false
        html.enabled true
//        html.destination file("${buildDir}/jacocoHtml")
    }
}

// Default values of the JaCoCo Task extension
test {
    jacoco {
        enabled = true
        destinationFile = file("$buildDir/jacoco/${name}.exec")
        includes = []
        excludes = []
        excludeClassLoaders = []
        includeNoLocationClasses = false
        sessionId = "<auto-generated value>"
        dumpOnExit = true
        classDumpDir = null
//        output = Output.FILE // does not compile
        address = "localhost"
        port = 6300
        jmx = false
    }
}


/*      SonarQube       */
tasks.sonarqube.dependsOn integrationTest

sonarqube {
    properties {
        property "sonar.host.url", "http://localhost:9000"

        if (doesHaveIntegrationTests) { // only adjust if integrationTest folder is created
            // available properties see https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-gradle/
            property "sonar.tests", [sourceSets.test.allSource.srcDirs, sourceSets.integrationTest.allSource.srcDirs]
            property "sonar.java.test.binaries", [sourceSets.test.output.classesDirs, sourceSets.integrationTest.output.classesDirs]
            property "sonar.java.test.libraries", [sourceSets.test.compileClasspath, sourceSets.integrationTest.compileClasspath]
            property "sonar.junit.reportPaths", ["$buildDir/test-results/test", "$buildDir/test-results/integrationTest"]
            property "sonar.jacoco.reportPaths", ["$buildDir/jacoco/test.exec", "$buildDir/jacoco/integrationTest.exec"]
        }
    }
}